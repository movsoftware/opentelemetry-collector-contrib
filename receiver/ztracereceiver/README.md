# Ztrace Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]: traces, metrics   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fztrace%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fztrace) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fztrace%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fztrace) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@open-telemetry/collector-contrib-approvers](https://github.com/orgs/open-telemetry/teams/collector-contrib-approvers) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

## Overview

The Ztrace receiver performs network traceroute operations to specified targets and converts the results into OpenTelemetry metrics and traces. It provides detailed hop-by-hop network path analysis with support for multiple protocols and enrichment with geolocation and ASN data.

## Features

- **Multi-protocol support**: UDP, ICMP, and TCP traceroute protocols
- **Concurrent tracing**: Trace multiple targets simultaneously
- **Rich metrics**: Latency, packet loss, jitter, and hop count metrics
- **Trace generation**: Creates distributed traces representing the network path
- **Geolocation enrichment**: Optional city and country information for each hop
- **ASN lookup**: Optional Autonomous System Number and provider information
- **Configurable intervals**: Set custom collection intervals for periodic tracing

## Configuration

The following settings are available:

| Setting | Required | Default | Description |
|---------|----------|---------|-------------|
| `endpoint` | no | `0.0.0.0:8888` | The endpoint for the receiver's HTTP server |
| `targets` | yes | | List of targets to trace |
| `targets[].endpoint` | yes | | Target hostname or IP address |
| `targets[].port` | conditional | | Target port (required for UDP/TCP) |
| `targets[].tags` | no | | Custom tags to add to metrics and traces |
| `collection_interval` | no | `60s` | How often to run traces |
| `timeout` | no | `10s` | Timeout for each trace operation |
| `protocol` | no | `udp` | Protocol to use: `udp`, `icmp`, or `tcp` |
| `max_hops` | no | `30` | Maximum number of hops to trace (1-64) |
| `packet_size` | no | `56` | Size of probe packets in bytes |
| `retries` | no | `3` | Number of retries per hop |
| `enable_geolocation` | no | `true` | Enable geolocation lookup |
| `enable_asn_lookup` | no | `true` | Enable ASN lookup |

### Example Configuration

```yaml
receivers:
  ztrace:
    endpoint: 0.0.0.0:8888
    collection_interval: 30s
    timeout: 10s
    protocol: udp
    max_hops: 30
    packet_size: 56
    retries: 3
    enable_geolocation: true
    enable_asn_lookup: true
    targets:
      - endpoint: example.com
        port: 80
        tags:
          environment: production
          region: us-west
      - endpoint: 8.8.8.8
        port: 53
        tags:
          service: dns
```

### ICMP Configuration

For ICMP protocol, the receiver may require elevated privileges:

```yaml
receivers:
  ztrace:
    protocol: icmp
    targets:
      - endpoint: google.com  # Port not required for ICMP
```

## Metrics

The receiver generates the following metrics:

| Metric | Unit | Type | Description | Attributes |
|--------|------|------|-------------|------------|
| `ztrace.hop.latency` | ms | Gauge | Latency for each hop | ttl, ip, hostname, city, country, asn, provider |
| `ztrace.hop.packet_loss` | % | Gauge | Packet loss percentage | ttl, ip |
| `ztrace.hop.jitter` | ms | Gauge | Jitter measurement | ttl, ip |
| `ztrace.total_latency` | ms | Gauge | Total latency to target | - |
| `ztrace.hop_count` | 1 | Gauge | Number of hops to target | - |

## Traces

The receiver generates distributed traces with the following structure:

- **Root span**: Represents the complete traceroute operation
  - Name: `traceroute to <target>`
  - Attributes: `hop.count`, `total.latency.ms`
  
- **Child spans**: One for each hop in the route
  - Name: `hop <ttl>: <ip>`
  - Attributes: `ttl`, `ip`, `hostname`, `latency.ms`, `packet_loss.percent`, `jitter.ms`
  - Optional attributes: `geo.city`, `geo.country`, `network.asn`, `network.provider`
  - Events: Generated for significant issues (e.g., high packet loss > 50%)

## Resource Attributes

All generated metrics and traces include the following resource attributes:

| Attribute | Description |
|-----------|-------------|
| `ztrace.target` | The target endpoint being traced |
| `ztrace.protocol` | The protocol used (udp, icmp, tcp) |
| `ztrace.port` | The target port (when applicable) |
| `service.name` | Set to "ztrace" for traces |
| Custom tags | Any tags specified in the target configuration |

## Platform Support

- **Linux**: Full support for all protocols
- **macOS**: Limited to ICMP and UDP protocols
- **Windows**: Limited support, may require administrator privileges

## Security Considerations

- ICMP tracing typically requires root/administrator privileges
- Be cautious when tracing external targets to avoid being flagged as suspicious network activity
- Consider rate limiting and target restrictions in production environments

## Integration Example

```yaml
receivers:
  ztrace:
    targets:
      - endpoint: api.example.com
        port: 443
        tags:
          service: api
    collection_interval: 60s

processors:
  batch:

exporters:
  prometheus:
    endpoint: 0.0.0.0:9090
  otlp:
    endpoint: otel-collector:4317

service:
  pipelines:
    metrics:
      receivers: [ztrace]
      processors: [batch]
      exporters: [prometheus]
    traces:
      receivers: [ztrace]
      processors: [batch]
      exporters: [otlp]
```

## Troubleshooting

### Permission Denied Errors

If you encounter permission errors, especially with ICMP:

1. Run the collector with elevated privileges (not recommended for production)
2. Use UDP protocol instead of ICMP
3. Configure appropriate capabilities on Linux:
   ```bash
   sudo setcap cap_net_raw+ep /path/to/otelcol
   ```

### No Response from Target

- Verify the target is reachable: `ping <target>`
- Check firewall rules that might block traceroute packets
- Try different protocols (UDP, ICMP, TCP)
- Increase the timeout value

### Missing Geolocation/ASN Data

- Ensure `enable_geolocation` and `enable_asn_lookup` are set to `true`
- Note that private IP addresses will not have this information
- Some hops may not resolve to meaningful location data